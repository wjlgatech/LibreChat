<!DOCTYPE html>
<html>
<head>
    <title>Microphone Permission Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; }
        #status { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Microphone Permission Test</h1>
    
    <button onclick="checkPermission()">Check Permission Status</button>
    <button onclick="requestPermission()">Request Permission</button>
    <button onclick="testMicrophone()">Test Microphone</button>
    <button onclick="testSpeechRecognition()">Test Speech Recognition</button>
    
    <div id="status"></div>
    
    <script>
    function log(message, type = 'info') {
        const status = document.getElementById('status');
        const entry = document.createElement('div');
        entry.className = type;
        entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
        status.appendChild(entry);
        console.log(message);
    }
    
    async function checkPermission() {
        try {
            const result = await navigator.permissions.query({ name: 'microphone' });
            log('Microphone permission status: ' + result.state, result.state === 'granted' ? 'success' : 'error');
            
            result.addEventListener('change', () => {
                log('Permission changed to: ' + result.state, result.state === 'granted' ? 'success' : 'error');
            });
        } catch (e) {
            log('Permission API not supported: ' + e.message, 'error');
        }
    }
    
    async function requestPermission() {
        try {
            log('Requesting microphone access...', 'info');
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            log('Microphone access granted!', 'success');
            
            // Show audio levels
            const audioContext = new AudioContext();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            microphone.connect(analyser);
            
            let maxLevel = 0;
            const checkLevel = () => {
                analyser.getByteFrequencyData(dataArray);
                const level = Math.max(...dataArray);
                if (level > maxLevel) {
                    maxLevel = level;
                    log('Audio level: ' + level + ' (speak into microphone)', 'info');
                }
            };
            
            // Check levels for 5 seconds
            const interval = setInterval(checkLevel, 100);
            setTimeout(() => {
                clearInterval(interval);
                stream.getTracks().forEach(track => track.stop());
                audioContext.close();
                log('Microphone test completed. Max level: ' + maxLevel, maxLevel > 0 ? 'success' : 'error');
            }, 5000);
            
        } catch (e) {
            log('Failed to access microphone: ' + e.message, 'error');
        }
    }
    
    function testMicrophone() {
        log('Testing basic microphone access...', 'info');
        
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                log('Microphone stream obtained', 'success');
                log('Audio tracks: ' + stream.getAudioTracks().length, 'info');
                stream.getAudioTracks().forEach((track, i) => {
                    log(`Track ${i}: ${track.label}, enabled: ${track.enabled}, muted: ${track.muted}`, 'info');
                });
                
                // Stop after showing info
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    log('Stream stopped', 'info');
                }, 2000);
            })
            .catch(err => {
                log('Microphone error: ' + err.name + ' - ' + err.message, 'error');
            });
    }
    
    function testSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            log('Speech recognition not supported', 'error');
            return;
        }
        
        try {
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            let startTime = Date.now();
            
            recognition.onstart = () => {
                startTime = Date.now();
                log('Recognition started', 'success');
            };
            
            recognition.onaudiostart = () => {
                log('Audio capture started', 'success');
            };
            
            recognition.onsoundstart = () => {
                log('Sound detected', 'info');
            };
            
            recognition.onspeechstart = () => {
                log('Speech detected', 'success');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                log('Transcript: ' + transcript, 'success');
            };
            
            recognition.onerror = (event) => {
                log('Recognition error: ' + event.error, 'error');
                if (event.error === 'not-allowed') {
                    log('Microphone access was denied', 'error');
                }
            };
            
            recognition.onend = () => {
                const duration = Date.now() - startTime;
                log('Recognition ended after ' + duration + 'ms', duration > 1000 ? 'info' : 'error');
            };
            
            log('Starting speech recognition...', 'info');
            recognition.start();
            
            // Stop after 10 seconds
            setTimeout(() => {
                log('Stopping recognition...', 'info');
                recognition.stop();
            }, 10000);
            
        } catch (e) {
            log('Failed to start recognition: ' + e.message, 'error');
        }
    }
    
    // Check permission on load
    window.onload = () => {
        checkPermission();
    };
    </script>
</body>
</html>